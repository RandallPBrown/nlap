<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pusher/4.4.0/pusher.min.js"></script> -->
<!-- <script>
    // Enable pusher logging - don't include this in production
    var pusher = new Pusher('<%#= ENV["PUSHER_KEY"] %>', {
      cluster: '<%#= ENV["PUSHER_CLUSTER"] %>',
      forceTLS: true
    });

    var ind_entry_count_channel = pusher.subscribe('entry');
    ind_entry_count_channel.bind('new-entry', function(data) {
      var indEntryCount = $('.entry-count').first().text();
      if (<%#= current_user.id %> == data.id) {
          $('.entry-count').html(parseFloat(indEntryCount) + parseFloat(data.ovalue))
      }
    });

    var ind_dap_count_channel = pusher.subscribe('dap');
    ind_dap_count_channel.bind('new-dap', function(data) {
      var indDapCount = $('.dap-count').first().text();
      if (<%#= current_user.id %> == data.id) {
          $('.dap-count').html(parseFloat(indDapCount) + 1)
      }
    });
</script> -->




<%= stylesheet_link_tag "pagination.css" %>
<%= render :layout => "layouts/base" do %>
  <nav class="navbar navbar-expand-lg" style="background-color: #4caf50 !important">
    <a href="javascript:" class="navbar-brand mr-auto p-0"><%= image_tag 'newleaf logo leaf.png', size: "35x35", class: 'bg-white rounded' %> </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-3">
        <li class="nav-item">
          <a class="nav-link text-white font-weight-bold" href="../users/dashboard" data-turbolinks="false"> <%= fa_icon_tag("home") %></a>
        </li>
        <% if current_user.department.name == "Pre-Approvals" || current_user.department.name == "Pending-Review" || current_user.department.name == "Executive" %>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white font-weight-bold" role="button" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false" aria-haspopup="true">  <%= fa_icon_tag("wrench") %></a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../tools/validator?template=Peyton.xml" data-turbolinks="false">Validator</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../parts" data-turbolinks="false">Part Verification</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../tools/pendingreview" data-turbolinks="false">Pending Review</a>
          </div>  
        </li>
        <% else %>
        <% end %>
        <% if current_user.admin? && current_user.has_role?(:reporting) %>
        <li class="nav-item">
          <a class="nav-link text-white font-weight-bold" href="../entries/dashboard" data-turbolinks="false"> <%= fa_icon_tag("pie-chart") %></a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white font-weight-bold" role="button" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false" aria-haspopup="true"> <%= fa_icon_tag("list") %></a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../entries" data-turbolinks="false">Occurrence Log</a>
        <% elsif current_user.admin? && (current_user.has_role?(:lead) || current_user.has_role?(:supervisor) || current_user.has_role?(:manager) || current_user.has_role?(:director) || current_user.has_role?(:executive)) %>
        <li class="nav-item">
          <a class="nav-link text-white font-weight-bold" href="../entries/dashboard" data-turbolinks="false"> <%= fa_icon_tag("pie-chart") %></a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white font-weight-bold" role="button" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false" aria-haspopup="true"> <%= fa_icon_tag("list") %></a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../entries" data-turbolinks="false">Occurrence Log</a>    
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../daps" data-turbolinks="false">Prog Action Log</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../err_logs" data-turbolinks="false">Improvement Log</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../agents" data-turbolinks="false">Agents List</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../kudos" data-turbolinks="false">Kudos Log</a>
          </div>  
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white font-weight-bold" role="button" id="navbarDropdown" data-toggle="dropdown" aria-expanded="false" aria-haspopup="true">  <%= fa_icon_tag("cogs") %></a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../departments">Departments</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../occurrences">Occurrences</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../writeups">Prog Actions</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../wunatures">Types of Incidents</a>
            <a class="downdown-item nav-link text-dark font-weight-bold" href="../users">User Management</a>
          </div>  
        </li>
        <% else %>
        <% end %>
        <% if current_user.admin == true %>
                <script>
            $(document).ready(function(t){
              $('.ticker').ticker();
            });
        </script>
        <span class="text-white font-weight-bold pl-4 pr-2 pull-right">RECENT KUDOS: </span>
        <div class="ticker">
          
          <ul>
              <% Kudo.all.order(date: :desc).where("kudo_status_id = ?", 2).each do |k| %>
                <li><span class="font-weight-bold text-white text-uppercase">[<%= k.date.strftime("%m/%d/%Y") %>]</span> <span class="font-weight-bold text-white text-uppercase"><%= k.user.full_name %></span> <%= fa_icon_tag 'star', class: 'text-warning' %> <span class="text-white font-weight-bold"><%= Kudo.all.order(date: :desc).where("user_id = ?", k.user_id).where('kudo_status_id = ?', 2).count(:id) %></span> <span class="font-weight-bold text-white text-uppercase">- <%= k.kudo_reason.description %></span></li>
              <% end %>
          </ul>
        </div>
        <% end %>
      </ul>
      
      <ul class="nav navbar-nav ml-auto">
<!--           <div class="dropdown">
            <button class="border-0 m-0 p-0" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <small class="badge bg-white text-dark mt-1 mr-0" style="border-radius: 3px 0px 0px 3px !important"><span class="text-uppercase"><span class="mr-1"><%= current_user.full_name %></span> | <span class="ml-1"><%= fa_icon_tag("caret-down") %></span></span>
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
              <% Kudo.all.uniq{|t| t.user_id }.each do |k| %>
                <button class="dropdown-item" type="button"><%= (k.user.full_name) + " | " + (Kudo.all.where("user_id = ?", k.user_id).count(:id)).to_s %></button>
              <% end %>
            </div>
          </div>
        </small> -->
<!--         <small class="badge badge-secondary ml-0 mt-1 mr-3" style="border-radius: 0px 3px 3px 0px !important">
          <span class="text-warning mr-1"><%= fa_icon_tag("star") %></span> | <small class="ml-1 font-weight-bold">+</small>0
        </small> -->
        <% if current_user.admin == true %>
        <script>
        function popKudoModal(){
          $('#kudosModal').modal('show')
        }
        </script>
        <small class="badge bg-white text-dark mt-1 mr-0 text-uppercase" style="border-radius: 3px 0px 0px 3px !important">
          <button type="button" class="btn p-0" onclick="popKudoModal()">SUBMIT KUDOS</button>
        </small>
        <small class="badge badge-secondary ml-0 mt-1 mr-3" style="border-radius: 0px 3px 3px 0px !important">
          <span class="text-warning mr-1"><%= fa_icon_tag("star") %></span> | <small class="ml-1 font-weight-bold">+</small><%= Kudo.all.where("user_id = ?", current_user.id).where("kudo_status_id = ?", 2).count(:id) %>
        </small>
        <% end %>
        <li class="nav-item dropdown user-nav rounded">
          <a class="nav-link text-white" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <%= fa_icon_tag("user") %>
            <span class="caret caret-light"></span>
          </a>
          <ul class="dropdown-menu dropdown-menu-right" role="menu">
            <li class="dropdown-item text-center">
              <div class="card">
                <div class="card-body bg-white">
                  <h4 class="m-auto font-weight-bold"><%= current_user.full_name %></h4>
                  <div class="row p-1 mt-2">
                    <div class="col-5">
                      <span class="pull-left"><strong>Email:</strong></span>
                    </div>
                    <div class="col-7 bg-white rounded">
                        <span class="pull-left"><%= user_email %></span>
                    </div>
                  </div>
                  <div class="row p-1">
                    <div class="col-5">
                      <span class="pull-left"><strong>Department:</strong></span> 
                    </div>
                    <div class="col-7 bg-white rounded">
                      <span class="pull-left"><%= user_department %></span>
                    </div>
                  </div>
                  <div class="row p-1">
                    <div class="col-5">
                      <span class="pull-left"><strong>Position:</strong></span> 
                    </div>
                    <div class="col-7 bg-white rounded">
                      <span class="pull-left text-capitalize"><%= current_user.roles.all.map{|f| f.name}.join(" ") %></span>
                    </div>
                  </div>
                  <div class="row p-1">
                    <div class="col-5">
                      <span class="pull-left"><strong>Prog Actions:</strong></span> 
                    </div>
                    <div class="col-7 bg-white rounded">
                      <span class="pull-left dap-count"><%= current_user.daps.ids.count %></span>
                    </div>
                  </div>
                </div>
                <div class="card-footer d-flex justify-content-between bg-white">
                  <div>
                    <%= link_to "EDIT USER", edit_user_path(current_user.id), :class => 'btn btn-primary text-white font-weight-bold mr-1' %>
                  </div>
                  <div>
                    <% if user_signed_in? %>
                      <%= link_to "LOGOUT", destroy_user_session_path, :method => :delete, :class => 'btn btn-primary text-white font-weight-bold ml-1' %>
                    <% else %>
                    <% end %>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </nav>
<div class="modal fade" id="kudosModal" tabindex="-1" role="dialog" aria-labelledby="kudosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="font-weight-bold" id="kudosModalLabel">Submit a Kudos!</h5>
        <button type="button" class="btn btn-sm" data-dismiss="modal" aria-label="Close">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
          <%= render partial: "kudos/form", locals: { kudo: Kudo.new } %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  <%= yield %>
<% end %>
